<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motherboard Interface</title>
    <style>
        /* CSS is identical to the previous version */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        html, body { height: 100%; margin: 0; }
        .line { white-space: pre-wrap; word-wrap: break-word; line-height: 1.3; }
        .prompt { display: flex; }
        .prompt-text { flex-shrink: 0; }
        #commandInput { background-color: transparent; border: none; font-family: inherit; font-size: inherit; flex-grow: 1; padding: 0; margin: 0; }
        #commandInput:focus { outline: none; }
        body.relic-theme { background-color: #1a2123; color: #d4d4d4; font-family: 'Share Tech Mono', monospace; font-size: 18px; }
        .relic-theme #terminal { padding: 10px; } .relic-theme .prompt-text { color: #E8772E; } .relic-theme #commandInput { color: #d4d4d4; } .relic-theme .system-msg { color: #00E5FF; text-shadow: 0 0 2px rgba(0, 229, 255, 0.5); } .relic-theme .error-msg, .relic-theme .data-msg-header { color: #E8772E; } .relic-theme .data-msg-body { color: #00E5FF; }
        body.terminal-theme { background-color: #000; color: #0f0; font-family: 'VT323', monospace; font-size: 22px; }
        .terminal-theme #terminal { padding: 10px; text-shadow: 0 0 3px #0f0; } .terminal-theme .prompt-text, .terminal-theme #commandInput, .terminal-theme .system-msg, .terminal-theme .error-msg, .terminal-theme .data-msg-header, .terminal-theme .data-msg-body { color: #0f0; }
        .terminal-theme::after { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); z-index: 2; background-size: 100% 4px, 3px 100%; pointer-events: none; animation: flicker 0.15s infinite; }
        @keyframes flicker { 0% { opacity: 0.2; } 20% { opacity: 0.6; } 40% { opacity: 0.3; } 60% { opacity: 0.7; } 80% { opacity: 0.4; } 100% { opacity: 0.6; } }
    </style>
    <script src="firebase-config.js"></script> <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="relic-theme"> <div id="terminal">
        <div class="prompt"><span class="prompt-text">>&nbsp;</span><input type="text" id="commandInput" autofocus></div>
    </div>

<script>
    // Firebase is initialized using the 'firebaseConfig' object from firebase-config.js
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const terminal = document.getElementById('terminal');
    const commandInput = document.getElementById('commandInput');

    let isConnected = false;
    let isScanning = false;
    let config = { theme: 'relic-theme', systemName: "SYSTEM", osName: "OS", scanCommand: "scan", connectCommand: "connect", dataNoun: "Data", signalNoun: "Signal" };

    // --- History Logic ---
    const RECEIVED_HISTORY_KEY = 'receivedMessageHistory';
    function saveMessageToHistory(message) {
        let history = JSON.parse(localStorage.getItem(RECEIVED_HISTORY_KEY)) || [];
        if (!history.length || history[0] !== message) {
             history.unshift(message); // Add new message to the top
             if (history.length > 20) history.pop(); // Keep only the last 20 messages
             localStorage.setItem(RECEIVED_HISTORY_KEY, JSON.stringify(history));
        }
    }

    // --- Dynamic Font Loader ---
    const fontLinkID = 'dynamic-font-link';
    function updateFont(theme) {
        let currentLink = document.getElementById(fontLinkID);
        if (currentLink) { currentLink.remove(); }
        const font = document.createElement('link');
        font.id = fontLinkID;
        font.rel = 'stylesheet';
        if (theme === 'terminal-theme') {
            font.href = 'https://fonts.googleapis.com/css2?family=VT323&display=swap';
        } else { // default to relic-theme font
            font.href = 'https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap';
        }
        document.head.appendChild(font);
    }

    // --- Terminal Logic ---
    function printLine(text, className = '') { const line = document.createElement('div'); line.textContent = text; line.className = 'line'; if (className) { line.classList.add(className); } terminal.insertBefore(line, terminal.lastElementChild); }
    function drawWelcomeMessage() { const welcomeLines = terminal.querySelectorAll('.welcome-line'); welcomeLines.forEach(line => line.remove()); const line1 = document.createElement('div'); line1.textContent = `Attempting to interface with ${config.systemName}... OK`; line1.className = 'line system-msg welcome-line'; const line2 = document.createElement('div'); line2.textContent = `${config.osName} -- Ready.`; line2.className = 'line system-msg welcome-line'; const line3 = document.createElement('div'); line3.textContent = `Type 'help' for command list.`; line3.className = 'line welcome-line'; const line4 = document.createElement('div'); line4.className = 'line welcome-line'; line4.innerHTML = '&nbsp;'; const prompt = terminal.querySelector('.prompt'); terminal.insertBefore(line1, prompt); terminal.insertBefore(line2, prompt); terminal.insertBefore(line3, prompt); terminal.insertBefore(line4, prompt); }

    function handleCommand(fullCmd) {
        printLine(`> ${fullCmd}`, 'prompt-text');
        const [cmd, ...args] = fullCmd.split(' ');
        const argString = args.join(' ');

        if (cmd === 'help') {
            printLine(`${config.systemName} Command List:`, 'system-msg');
            printLine(`  help          - Displays this list`);
            printLine(`  ${config.scanCommand.padEnd(13, ' ')} - Scan for active data ${config.signalNoun.toLowerCase()}s`);
            printLine(`  ${config.connectCommand.padEnd(13, ' ')} - Connect to a detected ${config.signalNoun.toLowerCase()}`);
            printLine(`  reply <msg>   - Sends a message back to source`);
            printLine(`  ping          - Checks connection to the source`);
            printLine(`  status        - Displays current system status`);
            printLine(`  history       - Shows received message history`);
            printLine(`  decode <data> - (Future Feature) Decode a datastream`);
            printLine(`  cls           - Clears the display`);
        } else if (cmd === config.scanCommand) {
            printLine(`Scanning for kohd-datastream ${config.signalNoun.toLowerCase()}s from ${config.systemName}...`);
            setTimeout(() => {
                printLine(`...Faint ${config.signalNoun} detected. Source confirmed: ${config.systemName}.`, 'system-msg');
                isScanning = true;
            }, 1500);
        } else if (cmd === config.connectCommand) {
            if (isScanning) {
                printLine(`Attempting to synchronize with ${config.systemName}...`);
                isConnected = true;
                printLine(`Synchronization complete. Interface active. Awaiting ${config.dataNoun}...`, 'system-msg');
            } else {
                printLine(`ERROR: No ${config.signalNoun} detected. Run ${config.scanCommand.toUpperCase()} first.`, 'error-msg');
            }
        } else if (cmd === 'cls') {
            const lines = terminal.querySelectorAll('.line:not(.welcome-line)');
            lines.forEach(line => line.remove());
        } else if (cmd === 'ping') {
            if (isConnected) {
                const latency = Math.floor(Math.random() * (150 - 40 + 1)) + 40;
                printLine(`PONG! Received reply from ${config.systemName} in ${latency}ms.`, 'system-msg');
            } else {
                printLine('ERROR: Not connected. Cannot ping target.', 'error-msg');
            }
        } else if (cmd === 'status') {
            printLine(`SYSTEM STATUS:`, 'system-msg');
            printLine(`  Connection:  ${isConnected ? `CONNECTED to ${config.systemName}` : 'OFFLINE'}`);
            printLine(`  Data Noun:   ${config.dataNoun}`);
            printLine(`  Signal Noun: ${config.signalNoun}`);
        } else if (cmd === 'decode') {
            printLine(`Feature not yet implemented. Please manually decode the ${config.dataNoun}.`, 'system-msg');
        } else if (cmd === 'reply') {
            if (isConnected) {
                if (argString) {
                    database.ref('player_reply').set(argString);
                    printLine(`Message sent: "${argString}"`, 'system-msg');
                } else {
                    printLine('ERROR: Cannot send an empty message. Usage: reply <message>', 'error-msg');
                }
            } else {
                printLine('ERROR: Must be connected to send a reply.', 'error-msg');
            }
        } else if (cmd === 'history') {
             const history = JSON.parse(localStorage.getItem(RECEIVED_HISTORY_KEY)) || [];
             if (history.length > 0) {
                printLine(`Received ${config.dataNoun} History:`, 'system-msg');
                history.forEach((msg, i) => printLine(`${(i + 1).toString().padStart(2, ' ')}: ${msg}`, 'data-msg-body'));
            } else {
                printLine(`No message history found.`);
            }
        }
        else {
            printLine(`ERROR: Unknown command. Refer to 'help' list.`, 'error-msg');
        }
    }

    commandInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const cmd = commandInput.value.trim().toLowerCase();
            if (cmd) { handleCommand(cmd); }
            commandInput.value = '';
            window.scrollTo(0, document.body.scrollHeight);
        }
    });

    // --- Firebase Listeners ---
    database.ref('terminal_config').on('value', (snapshot) => { const newConfig = snapshot.val(); if (newConfig) { config = newConfig; document.body.className = config.theme || 'relic-theme'; updateFont(config.theme); drawWelcomeMessage(); } });
    database.ref('kohd_datastream').on('value', (snapshot) => {
        const data = snapshot.val();
        if (isConnected && data) {
            printLine(`\n>>> INCOMING ${config.dataNoun.toUpperCase()} FROM ${config.systemName} <<<`, 'data-msg-header');
            printLine(data, 'data-msg-body');
            printLine(`>>> END OF ${config.dataNoun.toUpperCase()} <<<`, 'data-msg-header');
            saveMessageToHistory(data); // Save the received message to history
            window.scrollTo(0, document.body.scrollHeight);
        }
    });
</script>
</body>
</html>