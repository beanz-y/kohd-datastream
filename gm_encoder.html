<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daggerheart - Motherboard Signal Encoder</title>
    <style>
        /* ... existing styles ... */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        body { font-family: 'Share Tech Mono', monospace; background-color: #1a2123; color: #d4d4d4; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        h1 { color: #00E5FF; text-shadow: 0 0 5px rgba(0, 229, 255, 0.7); border-bottom: 1px solid #3a4a4d; padding-bottom: 10px;}
        h2 { color: #E8772E; font-size: 1.2em; margin-top: 30px; border-bottom: 1px solid #3a4a4d; padding-bottom: 5px; }
        label { display: block; margin: 10px 0 5px; }
        textarea, input[type="text"], select { width: 100%; padding: 8px; margin-bottom: 10px; background-color: #0e1213; color: #d4d4d4; border: 1px solid #3a4a4d; box-sizing: border-box; font-family: 'Share Tech Mono', monospace; font-size: 1em; }
        button { background-color: #00E5FF; color: #0e1213; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; font-family: 'Share Tech Mono', monospace; font-weight: 700; margin-right: 10px; }
        button.secondary { background-color: #E8772E; }
        button.critical { background-color: #ff3c3c; color: white; }
        button:hover { filter: brightness(1.2); }
        #outputBurst, #playerMessageDisplay { background-color: #0e1213; padding: 15px; border: 1px dashed #E8772E; word-wrap: break-word; min-height: 50px; font-size: 1.1em; color: #00E5FF; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        #cipher-key-container table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #cipher-key-container th, #cipher-key-container td { border: 1px solid #3a4a4d; padding: 5px; text-align: center; }
        #cipher-key-container th { color: #E8772E; }
        #cipher-key-container td { color: #00E5FF; }
        #cipher-key-container td.space { color: #6c7a7d; font-style: italic; }
        #historyContainer { max-height: 150px; overflow-y: auto; background-color: #0e1213; border: 1px solid #3a4a4d; padding: 10px; }
        .historyItem { padding: 5px; cursor: pointer; border-bottom: 1px solid #1a2123; }
        .historyItem:hover { background-color: #E8772E; color: #0e1213; }
        #keyManagementGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; background-color: #0e1213; border: 1px solid #3a4a4d; padding: 15px; margin-bottom: 10px; }
        .key-switch { display: flex; align-items: center; justify-content: space-between; }
        .key-switch label { margin: 0; font-weight: bold; color: #00E5FF; }
        .key-switch input { height: 0; width: 0; visibility: hidden; }
        .key-switch .slider { cursor: pointer; width: 34px; height: 18px; background-color: #555; display: inline-block; border-radius: 18px; position: relative; }
        .key-switch .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .2s; }
        .key-switch input:checked + .slider { background-color: #E8772E; }
        .key-switch input:checked + .slider:before { transform: translateX(16px); }
        .section-header { display: flex; align-items: center; justify-content: space-between; }
        #fileList { list-style: none; padding: 0; }
        #fileList li { background-color: #0e1213; padding: 8px; border-left: 3px solid #00E5FF; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        #fileList button { font-size: 12px; padding: 3px 8px; }
        .locked { border-left-color: #E8772E !important; }
        .glitch-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        fieldset { border: 1px solid #3a4a4d; padding: 15px; margin-bottom: 10px; }
        legend { color: #E8772E; padding: 0 5px; font-weight: bold; }
        #playerStatus { font-size: 1.2em; padding: 5px 10px; border-radius: 5px; }
        #playerStatus.offline { background-color: #E8772E; color: #1a2123; }
        #playerStatus.online { background-color: #00E5FF; color: #1a2123; }
        #templateButtons { display: flex; flex-wrap: wrap; gap: 10px; }
    </style>
    <script src="firebase-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
<div class="container">
    <div class="section-header">
      <h1>Motherboard Signal Encoder</h1>
      <span id="playerStatus" class="offline">OFFLINE</span>
    </div>
    <h2>Terminal Configuration</h2>
    <div class="config-grid">
        <div><label for="systemName">System Name</label><input type="text" id="systemName" value="MOTHERBOARD"></div>
        <div><label for="osName">OS Name</label><input type="text" id="osName" value="M-OS v1.0"></div>
        <div><label for="scanCommand">Scan Command</label><input type="text" id="scanCommand" value="seek_source"></div>
        <div><label for="connectCommand">Connect Command</label><input type="text" id="connectCommand" value="awaken"></div>
        <div><label for="dataNoun">Data Noun (e.g., Echo)</label><input type="text" id="dataNoun" value="Echo"></div>
        <div><label for="signalNoun">Signal Noun (e.g., Signature)</label><input type="text" id="signalNoun" value="Signature"></div>
    </div>
    <div><label for="themeSelect">Terminal Theme</label><select id="themeSelect"><option value="relic-theme">Relic (Horizon)</option><option value="terminal-theme">Terminal (Classic Green)</option></select></div>
    <button id="updateConfigButton" class="secondary">Update Terminal Config</button>

    <h2>Decryption Key Management</h2>
    <div id="keyManagementGrid"></div>
    <button id="unlockAllButton">Unlock All</button>
    <button id="lockAllButton" class="secondary">Lock All</button>

    <h2>System Glitches</h2>
    <fieldset>
        <legend>Minor Glitches</legend>
        <div class="glitch-controls">
            <button id="scrambleMessageButton" class="secondary">Scramble Next Message</button>
            <button id="glitchCommandButton" class="secondary">Glitch Command</button>
            <select id="glitchCommandSelect">
                <option value="ping">ping</option>
                <option value="ls">ls</option>
                <option value="cat">cat</option>
                <option value="status">status</option>
            </select>
        </div>
    </fieldset>

    <fieldset>
        <legend>System Override</legend>
        <div class="glitch-controls">
             <button id="triggerLockoutButton" class="critical">Trigger Lockout</button>
             <button id="triggerWarningButton" class="critical">Send Warning</button>
             <input type="text" id="customWarningInput" placeholder="Or send a custom warning..." style="flex-grow:1;">
        </div>
         <button id="clearOverrideButton" style="margin-top:10px;">Clear Override</button>
    </fieldset>

    <h2>File System Management</h2>
    <label for="newFileName">Filename (e.g., log.txt)</label>
    <input type="text" id="newFileName" placeholder="Enter filename...">
    <label for="newFilePassword">Password (optional)</label>
    <input type="text" id="newFilePassword" placeholder="Enter password to lock file...">
    <label for="newFileContent">File Content</label>
    <textarea id="newFileContent" rows="4" placeholder="Enter file content..."></textarea>
    <button id="createFileButton">Create File</button>
    <h3>Existing Files:</h3>
    <ul id="fileList"></ul>

    <h2>Datastream Transmission</h2>
    <fieldset>
        <legend>Message Templates</legend>
        <div id="templateButtons"></div>
    </fieldset>
    <label for="messageInput">Data Fragment:</label><textarea id="messageInput">COORDINATES RECEIVED. STAND BY.</textarea>
    <label for="noiseSlider">Signal Corruption: <span id="noiseValue">50</span></label><input type="range" id="noiseSlider" min="0" max="200" value="50" style="width: 100%;">
    <button id="encodeButton">Transmit Datastream</button>
    <h3>Transmitted kohd-datastream:</h3><div id="outputBurst"></div>

    <div class="section-header">
      <h2>Transmission History</h2>
      <button id="clearHistoryButton" class="secondary" style="font-size: 12px; padding: 5px 10px;">Clear History</button>
    </div>
    <div id="historyContainer"></div>

    <h2>Incoming Player Message</h2>
    <div id="playerMessageDisplay">Awaiting message from player terminal...</div>
    
    <div class="section-header">
      <h2>Cipher Key</h2>
      <button id="generateCipherButton" class="secondary" style="font-size: 12px; padding: 5px 10px;">Generate New Cipher</button>
    </div>
    <div id="cipher-key-container"></div>
</div>

<script>
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- Element Selectors ---
    const systemNameInput = document.getElementById('systemName'), osNameInput = document.getElementById('osName'), scanCommandInput = document.getElementById('scanCommand'), connectCommandInput = document.getElementById('connectCommand'), dataNounInput = document.getElementById('dataNoun'), signalNounInput = document.getElementById('signalNoun'), themeSelect = document.getElementById('themeSelect'), updateConfigButton = document.getElementById('updateConfigButton');
    const messageInput = document.getElementById('messageInput'), noiseSlider = document.getElementById('noiseSlider'), noiseValue = document.getElementById('noiseValue'), encodeButton = document.getElementById('encodeButton'), outputBurst = document.getElementById('outputBurst');
    const playerMessageDisplay = document.getElementById('playerMessageDisplay');
    const cipherContainer = document.getElementById('cipher-key-container'), generateCipherButton = document.getElementById('generateCipherButton');
    const historyContainer = document.getElementById('historyContainer'), clearHistoryButton = document.getElementById('clearHistoryButton');
    const keyManagementGrid = document.getElementById('keyManagementGrid'), unlockAllButton = document.getElementById('unlockAllButton'), lockAllButton = document.getElementById('lockAllButton');
    const newFileNameInput = document.getElementById('newFileName'), newFilePasswordInput = document.getElementById('newFilePassword'), newFileContentInput = document.getElementById('newFileContent'), createFileButton = document.getElementById('createFileButton'), fileList = document.getElementById('fileList');
    const scrambleMessageButton = document.getElementById('scrambleMessageButton'), glitchCommandButton = document.getElementById('glitchCommandButton'), glitchCommandSelect = document.getElementById('glitchCommandSelect');
    const triggerLockoutButton = document.getElementById('triggerLockoutButton'), triggerWarningButton = document.getElementById('triggerWarningButton'), customWarningInput = document.getElementById('customWarningInput'), clearOverrideButton = document.getElementById('clearOverrideButton');
    const playerStatus = document.getElementById('playerStatus');
    const templateButtons = document.getElementById('templateButtons');

    // --- DB References ---
    const dbRefs = {
        keys: database.ref('decryption_keys'),
        historyClear: database.ref('history_cleared_timestamp'),
        fileSystem: database.ref('file_system'),
        glitches: database.ref('glitches'),
        playerStatus: database.ref('player_status'),
        cipher: database.ref('cipher_config')
    };

    // --- Data ---
    const symbols = ['<', '>', '%', '^', '&', '*', '-', '+', '@'];
    const groups = ['<', '>', '%', '^', '&'];
    let encodingChart = {};
    const doubledSymbols = ['<<', '>>', '%%', '^^', '&&', '**', '--', '++', '@@'];
    const MESSAGE_TEMPLATES = [ "CONNECTION UNSTABLE", "SIGNAL BOOSTED", "SECURITY ALERT", "TRACE DETECTED", "ACKNOWLEDGED", "STAND BY..." ];
    // **FIXED:** Define a stable default cipher
    const defaultEncodingChart = {'A': '<>', 'B': '<%', 'C': '<^', 'D': '<&', 'E': '<*', 'F': '<-', 'G': '<+', 'H': '<@','I': '><', 'J': '>%', 'K': '>^', 'L': '>&', 'M': '>*', 'N': '>-', 'O': '>+', 'P': '>@','Q': '%<', 'R': '%>', 'S': '%^', 'T': '%&', 'U': '%*', 'V': '%-', 'W': '%+', 'X': '%@','Y': '^<', 'Z': '^>', '0': '^%', '1': '^&', '2': '^*', '3': '^-', '4': '^+', '5': '^@','6': '&<', '7': '&>', '8': '&%', '9': '&^'};

    // --- Player Status Logic (unchanged) ---
    dbRefs.playerStatus.on('value', (snapshot) => { const status = snapshot.val(); if (status && status.isConnected) { playerStatus.textContent = 'ONLINE'; playerStatus.className = 'online'; } else { playerStatus.textContent = 'OFFLINE'; playerStatus.className = 'offline'; } });

    // --- Key Management & Glitch Logic (unchanged) ---
    function generateKeySwitches(keys) { keyManagementGrid.innerHTML = ''; const allChars = Object.keys(encodingChart).sort(); allChars.forEach(char => { const isChecked = keys[char] === true; const switchWrapper = document.createElement('div'); switchWrapper.className = 'key-switch'; switchWrapper.innerHTML = `<label for="key-${char}">${char}</label><label class="switch"><input type="checkbox" id="key-${char}" ${isChecked ? 'checked' : ''}><span class="slider"></span></label>`; keyManagementGrid.appendChild(switchWrapper); document.getElementById(`key-${char}`).addEventListener('change', (e) => { dbRefs.keys.child(char).set(e.target.checked); }); }); }
    function setAllKeys(state) { const updates = {}; Object.keys(encodingChart).forEach(char => { updates[char] = state; }); dbRefs.keys.set(updates); }
    unlockAllButton.onclick = () => setAllKeys(true);
    lockAllButton.onclick = () => setAllKeys(false);
    dbRefs.keys.on('value', (snapshot) => { const keys = snapshot.val() || {}; generateKeySwitches(keys); });
    scrambleMessageButton.onclick = () => { dbRefs.glitches.child('scramble_next').set(true); alert('Next message will be scrambled!'); };
    glitchCommandButton.onclick = () => { const commandToGlitch = glitchCommandSelect.value; dbRefs.glitches.child('glitched_command').set(commandToGlitch); alert(`Command "${commandToGlitch}" will be glitched for 30 seconds.`); setTimeout(() => dbRefs.glitches.child('glitched_command').remove(), 30000); };
    triggerLockoutButton.onclick = () => { dbRefs.glitches.child('override_state').set({ type: 'lockout', message: 'CONNECTION TERMINATED' }); };
    triggerWarningButton.onclick = () => { const message = customWarningInput.value.trim() || '!! INTRUSION DETECTED !!'; dbRefs.glitches.child('override_state').set({ type: 'warning', message: message }); customWarningInput.value = ''; };
    clearOverrideButton.onclick = () => { dbRefs.glitches.child('override_state').remove(); };
    
    // --- History Logic (unchanged) ---
    const GM_HISTORY_KEY = 'gmMessageHistory';
    function saveToHistory(message) { let history = JSON.parse(localStorage.getItem(GM_HISTORY_KEY)) || []; if (!history.includes(message)) { history.unshift(message); } if (history.length > 20) history.pop(); localStorage.setItem(GM_HISTORY_KEY, JSON.stringify(history)); displayHistory(); }
    function displayHistory() { let history = JSON.parse(localStorage.getItem(GM_HISTORY_KEY)) || []; historyContainer.innerHTML = ''; if (history.length === 0) { historyContainer.innerHTML = '<div class="historyItem" style="cursor:default; color:#6c7a7d;">No history yet.</div>'; } else { history.forEach(message => { const item = document.createElement('div'); item.className = 'historyItem'; item.textContent = message; item.onclick = () => { messageInput.value = message; }; historyContainer.appendChild(item); }); } }
    clearHistoryButton.onclick = () => { if (confirm('Are you sure you want to clear the transmission history for yourself and all players?')) { localStorage.removeItem(GM_HISTORY_KEY); displayHistory(); dbRefs.historyClear.set(firebase.database.ServerValue.TIMESTAMP); } };

    // --- File System Logic (unchanged) ---
    createFileButton.onclick = () => { const fileName = newFileNameInput.value.trim().toLowerCase(); const filePassword = newFilePasswordInput.value.trim(); const fileContent = newFileContentInput.value; if (!fileName || !fileContent) { alert('Filename and content cannot be empty.'); return; } if (!fileName.includes('.')) { alert('Filename must include an extension (e.g., .txt, .log)'); return; } const safeFileName = fileName.replace(/\./g, '·'); const fileData = { content: fileContent }; if (filePassword) { fileData.password = filePassword; } dbRefs.fileSystem.child(safeFileName).set(fileData); newFileNameInput.value = ''; newFileContentInput.value = ''; newFilePasswordInput.value = ''; };
    dbRefs.fileSystem.on('value', (snapshot) => { fileList.innerHTML = ''; const files = snapshot.val(); if (files) { Object.keys(files).forEach(safeFileName => { const originalFileName = safeFileName.replace(/·/g, '.'); const fileData = files[safeFileName]; const li = document.createElement('li'); if (fileData.password) { li.classList.add('locked'); li.textContent = `${originalFileName} [LOCKED]`; } else { li.textContent = originalFileName; } const deleteButton = document.createElement('button'); deleteButton.textContent = 'Delete'; deleteButton.className = 'secondary'; deleteButton.onclick = () => { if (confirm(`Are you sure you want to delete ${originalFileName}?`)) { dbRefs.fileSystem.child(safeFileName).remove(); } }; li.appendChild(deleteButton); fileList.appendChild(li); }); } });
    
    // --- Other Logic (unchanged) ---
    updateConfigButton.onclick = () => { const config = { systemName: systemNameInput.value, osName: osNameInput.value, scanCommand: scanCommandInput.value.toLowerCase(), connectCommand: connectCommandInput.value.toLowerCase(), dataNoun: dataNounInput.value, signalNoun: signalNounInput.value, theme: themeSelect.value }; database.ref('terminal_config').set(config); alert('Terminal configuration updated!'); };
    noiseSlider.oninput = () => { noiseValue.textContent = noiseSlider.value; };
    function generateNoise(length) { let noise = ''; for (let i = 0; i < length; i++) { noise += symbols[Math.floor(Math.random() * symbols.length)]; } return noise; }
    function encodeMessage(message) { let encoded = ''; message = message.toUpperCase(); for (const char of message) { if (char === ' ') { encoded += doubledSymbols[Math.floor(Math.random() * doubledSymbols.length)]; } else if (encodingChart[char]) { encoded += encodingChart[char]; } } return encoded; }
    encodeButton.onclick = () => { const message = messageInput.value; if (!message) return; saveToHistory(message); const noiseLength = parseInt(noiseSlider.value, 10); const encodedPart = encodeMessage(message); const leadingNoise = generateNoise(Math.floor(noiseLength / 2)); const trailingNoise = generateNoise(Math.ceil(noiseLength / 2)); const finalBurst = `${leadingNoise}$:${encodedPart}:#${trailingNoise}`; outputBurst.textContent = finalBurst; database.ref('kohd_datastream').set(finalBurst); };
    
    // --- Cipher Logic ---
    function displayCipherKey(chart) { const reversedChart = Object.fromEntries(Object.entries(chart).map(a => a.reverse())); let tableHTML = '<table><thead><tr><th></th>'; symbols.forEach(s => tableHTML += `<th>${s}</th>`); tableHTML += '</tr></thead><tbody>'; groups.forEach(group => { tableHTML += `<tr><th>${group}</th>`; symbols.forEach(pos => { const pair = group + pos; let cellContent = reversedChart[pair] || '[BLANK]'; if (group === pos) cellContent = '[SPACE]'; let cellClass = (cellContent === '[SPACE]' || cellContent === '[BLANK]') ? 'class="space"' : ''; tableHTML += `<td ${cellClass}>${cellContent}</td>`; }); tableHTML += '</tr>'; }); tableHTML += '</tbody></table>'; cipherContainer.innerHTML = tableHTML; }
    generateCipherButton.onclick = () => { if (!confirm('This will generate a new cipher and may disrupt player decoding. Continue?')) return; const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.split(''); const shuffledSymbols = [...symbols].sort(() => 0.5 - Math.random()); const newChart = {}; for(let i = 0; i < chars.length; i++) { const group = groups[Math.floor(i / shuffledSymbols.length)]; const symbol = shuffledSymbols[i % shuffledSymbols.length]; if(group !== symbol) { newChart[chars[i]] = group + symbol; } else { newChart[chars[i]] = shuffledSymbols[0] + shuffledSymbols[1]; } } dbRefs.cipher.set(newChart); dbRefs.keys.remove(); alert('New cipher generated and synced.'); };
    
    // **FIXED:** Cipher loading logic
    dbRefs.cipher.on('value', (snapshot) => {
        if (snapshot.exists()) {
            encodingChart = snapshot.val();
        } else {
            // If no cipher exists in DB, set it to the default one.
            encodingChart = defaultEncodingChart;
            dbRefs.cipher.set(defaultEncodingChart);
        }
        displayCipherKey(encodingChart);
        dbRefs.keys.on('value', (snapshot) => { const keys = snapshot.val() || {}; generateKeySwitches(keys); });
    });
    
    // --- Initial calls ---
    MESSAGE_TEMPLATES.forEach(template => { const btn = document.createElement('button'); btn.textContent = template; btn.onclick = () => messageInput.value = template; templateButtons.appendChild(btn); });
    database.ref('player_reply').on('value', (snapshot) => { const message = snapshot.val(); if (message) { playerMessageDisplay.textContent = message; } else { playerMessageDisplay.textContent = 'Awaiting message from player terminal...'; } });
    displayHistory();
</script>
</body>
</html>